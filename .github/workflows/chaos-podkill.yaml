name: Chaos Mesh kill pod
run-name: Chaos Mesh kill Pod run by ${{ github.actor }}
on: [push]
jobs:
  chaos-pod-kill:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
      - name: ðŸ› ï¸ Install Helm
        uses: azure/setup-helm@v4.3.0
      - name: â˜ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-3
      - name: ðŸ” Configure Kubeconfig
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}
      - run: |
          echo "ðŸ“‹ rgatt pods before pod-kill :"
          kubectl get pods -l app=rgatt -n rgatt -o wide
      - name: â˜ ï¸ Kill one pod with Chaos Mesh
        run: |
          # Debug du template gÃ©nÃ©rÃ©
          helm template chaos-rgatt-ci ./chaos/helm \
            --namespace chaos-mesh \
            -f ./chaos/value-rgatt.yaml \
            --set simulation.podKill.enabled=true \
            --set simulation.podKill.value="50" > debug.yaml
          
          echo "=== Template ==="
          cat debug.yaml
          
          # Application directe avec kubectl
          kubectl apply -f debug.yaml
      - run: sleep 10          
      - run: |
          echo "ðŸ“‹ rgatt pods after pod-kill :"
          kubectl get pods -l app=rgatt -n rgatt -o wide
